<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสถิติห้องสมุดวิทยาลัยอาชีวศึกษาสุรินทร์</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pastel-blue': '#AEC6CF',
                        'pastel-blue-light': '#E0F7FA',
                        'pastel-blue-dark': '#8DA0A8',
                        'pastel-yellow': '#FFFACD',
                        'pastel-yellow-dark': '#FDF5A6',
                        'soft-text': '#546E7A',
                        'pastel-green': '#C1E1C1',
                        'pastel-red': '#FFB7B2',
                        'theme-1': '#26A69A',
                        'theme-2': '#AED581',
                        'theme-3': '#FFCA28',
                        'theme-4': '#FF8A65',
                        'theme-5': '#EF5350',
                        'theme-6': '#4A2C6D',
                        'theme-7': '#D32F2F',
                        'theme-8': '#F57C00',
                        'theme-9': '#FBC02D',
                        'theme-10': '#0288D1'
                    },
                    fontFamily: {
                        'thai': ['"Sarabun"', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #FFFDE7; /* Very light yellow background */
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .nav-item.active {
            background-color: #AEC6CF;
            color: white;
            font-weight: 600;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #AEC6CF; 
            border-radius: 4px;
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Gradient Backgrounds for Stats Cards */
        .gradient-card-1 {
            background: linear-gradient(135deg, #26A69A, #4DB6AC);
        }
        .gradient-card-2 {
            background: linear-gradient(135deg, #AED581, #C5E1A5);
        }
        .gradient-card-3 {
            background: linear-gradient(135deg, #FFCA28, #FFD54F);
        }
        .gradient-card-4 {
            background: linear-gradient(135deg, #FF8A65, #FFAB91);
        }
        .gradient-card-5 {
            background: linear-gradient(135deg, #EF5350, #E57373);
        }
        .gradient-card-6 {
            background: linear-gradient(135deg, #4A2C6D, #6A4C93);
        }
        .gradient-card-7 {
            background: linear-gradient(135deg, #D32F2F, #F44336);
        }
        .gradient-card-8 {
            background: linear-gradient(135deg, #F57C00, #FF9800);
        }
        .gradient-card-9 {
            background: linear-gradient(135deg, #FBC02D, #FFEB3B);
        }
        .gradient-card-10 {
            background: linear-gradient(135deg, #0288D1, #03A9F4);
        }
        
        /* Hover effects for cards */
        .gradient-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .gradient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Improved chart containers */
        .chart-container {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 1rem;
        }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Loading Spinner -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-pastel-blue-dark"></div>
    </div>

<aside class="w-full md:w-64 bg-gradient-to-b from-theme-1 to-theme-6 shadow-xl flex-shrink-0 flex flex-col z-20">
    <div class="p-6 bg-white/10 border-b border-white/20 flex items-center justify-between md:block backdrop-blur-sm">
        <div class="flex items-center gap-3">
          <img src="https://img2.pic.in.th/pic/2567400ea770e561a063.png" alt="โลโก้ห้องสมุด" class="w-12 h-12 rounded-full object-cover border-2 border-white/20 shadow-sm">
            <!-- <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-white text-2xl backdrop-blur-md">
                <i class="fas fa-book-reader"></i>
            </div> -->
            <div>
                <h1 class="text-xl font-bold text-white">ห้องสมุด วอศ.สุรินทร์</h1>
                <p class="text-xs text-white/80">Library System SRVC</p>
            </div>
        </div>
        
        <button class="md:hidden text-white/80 hover:text-white transition-colors" onclick="toggleMobileMenu()">
            <i class="fas fa-bars text-2xl"></i>
        </button>
    </div>

    <nav id="sidebarNav" class="flex-1 p-4 space-y-2 hidden md:block overflow-y-auto">
        <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-4 py-4 rounded-xl hover:bg-white/10 transition-all duration-300 flex items-center gap-3 active bg-white/20 text-white border border-white/20 shadow-md">
            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                <i class="fas fa-chart-pie"></i>
            </div>
            <span class="font-medium">ภาพรวมสถิติ</span>
        </button>
        
        <button onclick="switchPage('form')" id="nav-form" class="nav-item w-full text-left px-4 py-4 rounded-xl hover:bg-white/10 transition-all duration-300 flex items-center gap-3 text-white/90 hover:text-white">
            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                <i class="fas fa-user-edit"></i>
            </div>
            <span class="font-medium">บันทึกการใช้งาน</span>
        </button>
        
        <button onclick="switchPage('borrow')" id="nav-borrow" class="nav-item w-full text-left px-4 py-4 rounded-xl hover:bg-white/10 transition-all duration-300 flex items-center gap-3 text-white/90 hover:text-white">
            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                <i class="fas fa-book"></i>
            </div>
            <span class="font-medium">ยืม-คืนหนังสือ</span>
        </button>

        <div class="pt-4">
            <button onclick="handleAdminClick('admin')" id="nav-admin" class="nav-item w-full text-left px-4 py-4 rounded-xl hover:bg-white/10 transition-all duration-300 flex items-center gap-3 justify-between group text-white/90 hover:text-white border border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-theme-9 to-theme-8 flex items-center justify-center">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <span class="font-medium">ผู้ดูแลระบบ</span>
                </div>
                <i class="fas fa-lock text-xs text-white/60 group-hover:text-white"></i>
            </button>

            <button onclick="handleAdminClick('database')" id="nav-database" class="nav-item w-full text-left px-4 py-4 rounded-xl hover:bg-white/10 transition-all duration-300 flex items-center gap-3 justify-between group text-white/90 hover:text-white border border-white/10 mt-2">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-theme-10 to-theme-1 flex items-center justify-center">
                        <i class="fas fa-database"></i>
                    </div>
                    <span class="font-medium">ฐานข้อมูล</span>
                </div>
                <i class="fas fa-lock text-xs text-white/60 group-hover:text-white"></i>
            </button>
        </div>
        
        <div class="pt-8 mt-6 border-t border-white/20">
            <p class="px-4 text-xs font-semibold text-white/60 uppercase tracking-wider mb-3">System Status</p>
            
            <div class="px-4 py-3 rounded-xl bg-white/10 backdrop-blur-sm border border-white/10 mb-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        <span class="text-xs font-medium text-white/80">สถานะระบบ</span>
                    </div>
                    <span id="connectionStatus" class="text-xs font-semibold text-white">Online</span>
                </div>
                <div class="mt-2 text-xs text-white/60 flex items-center">
                    <i class="fas fa-wifi mr-1"></i>
                    <span>เชื่อมต่อ Google Sheet</span>
                </div>
            </div>
            
            <button onclick="refreshData()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/10 transition-all duration-300 flex items-center gap-3 text-white/80 hover:text-white group">
                <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div>
                    <span class="font-medium block">Refresh Data</span>
            <span class="text-xs text-white/60">อัพเดทข้อมูลล่าสุด</span>
                </div>
            </button>
        </div>
    </nav>
</aside>

<script>
// เพิ่มฟังก์ชันสำหรับ toggle mobile menu
function toggleMobileMenu() {
    const sidebarNav = document.getElementById('sidebarNav');
    sidebarNav.classList.toggle('hidden');
}
</script>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-pastel-yellow/30 relative">
        
<!-- PAGE: DASHBOARD -->
<div id="page-dashboard" class="page-section space-y-6">
    <!-- Header Section -->
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-r from-theme-1 to-theme-2 rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-chart-pie text-xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-soft-text">แผงควบคุมภาพรวม</h2>
                <p class="text-sm text-gray-500">สถิติการใช้งานห้องสมุดประจำวัน แบบเรียลไทม์</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <span class="text-sm font-medium bg-white px-3 py-2 rounded-full shadow-sm text-theme-1 border border-gray-100 flex items-center gap-2">
                    <i class="fas fa-calendar-day text-theme-2"></i>
                    <span id="currentDateDisplay">--/--/----</span>
                </span>
            </div>
            <button onclick="refreshData()" class="bg-white hover:bg-gray-50 text-theme-1 px-3 py-2 rounded-full shadow-sm border border-gray-100 transition-all duration-200 hover:shadow-md">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>

    <!-- Real-time Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Today's Visitors -->
        <div class="gradient-card gradient-card-1 p-5 rounded-xl shadow-lg text-white gradient-card transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-user-clock"></i>
                        ผู้เข้าใช้ (วันนี้)
                    </p>
                    <h3 class="text-3xl font-bold mt-1" id="stat-today">0</h3>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-arrow-trend-up text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="today-trend">+0% จากเมื่อวาน</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-users text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Monthly Visitors -->
        <div class="gradient-card gradient-card-2 p-5 rounded-xl shadow-lg text-white gradient-card transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-calendar-alt"></i>
                        ผู้เข้าใช้ (เดือนนี้)
                    </p>
                    <h3 class="text-3xl font-bold mt-1" id="stat-month">0</h3>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-chart-line text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="month-trend">+0% จากเดือนที่แล้ว</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-chart-bar text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Popular Class -->
        <div class="gradient-card gradient-card-3 p-5 rounded-xl shadow-lg text-white gradient-card transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-graduation-cap"></i>
                        ระดับชั้นยอดนิยม
                    </p>
                    <h3 class="text-2xl font-bold mt-1" id="stat-top-class">-</h3>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-trophy text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="top-class-count">0 คน</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-crown text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Main Purpose -->
        <div class="gradient-card gradient-card-4 p-5 rounded-xl shadow-lg text-white gradient-card transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-book-open"></i>
                        วัตถุประสงค์หลัก
                    </p>
                    <h3 class="text-2xl font-bold mt-1" id="stat-top-purpose">-</h3>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-star text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="top-purpose-count">0 ครั้ง</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-bullseye text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <button onclick="switchPage('form')" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-theme-1 group hover:bg-theme-1/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-theme-1 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-user-edit"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-theme-1">บันทึกการเข้าใช้</p>
                    <p class="text-xs text-gray-500">เพิ่มรายการใหม่</p>
                </div>
            </div>
        </button>

        <button onclick="switchPage('borrow')" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-theme-2 group hover:bg-theme-2/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-theme-2 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-book"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-theme-2">ยืม-คืนหนังสือ</p>
                    <p class="text-xs text-gray-500">จัดการหนังสือ</p>
                </div>
            </div>
        </button>

        <button onclick="exportToExcel()" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-theme-3 group hover:bg-theme-3/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-theme-3 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-theme-3">Export Excel</p>
                    <p class="text-xs text-gray-500">ดาวน์โหลดข้อมูล</p>
                </div>
            </div>
        </button>

        <button onclick="generateReport()" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-theme-4 group hover:bg-theme-4/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-theme-4 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-theme-4">สร้างรายงาน</p>
                    <p class="text-xs text-gray-500">สรุปสถิติ</p>
                </div>
            </div>
        </button>
    </div>

    

    <!-- Charts Section -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- Daily Statistics Chart -->
        <div class="glass-panel p-6 xl:col-span-2 shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-soft-text flex items-center gap-2">
                    <div class="w-8 h-8 bg-theme-1 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-chart-line text-sm"></i>
                    </div>
                    สถิติรายวัน (7 วันล่าสุด)
                </h3>
                <div class="flex gap-2">
                    <button onclick="changeChartPeriod('week')" class="chart-period-btn active bg-theme-1 text-white px-3 py-1 rounded-lg text-xs">
                        7 วัน
                    </button>
                    <button onclick="changeChartPeriod('month')" class="chart-period-btn bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-xs">
                        30 วัน
                    </button>
                </div>
            </div>
            <div class="h-72">
                <canvas id="chartDaily"></canvas>
            </div>
        </div>

        <!-- Purpose Distribution -->
        <div class="glass-panel p-6 shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-soft-text flex items-center gap-2">
                    <div class="w-8 h-8 bg-theme-2 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-chart-pie text-sm"></i>
                    </div>
                    วัตถุประสงค์การใช้งาน
                </h3>
            </div>
            <div class="h-72 flex justify-center">
                <canvas id="chartPurpose"></canvas>
            </div>
        </div>
    </div>

    <!-- Second Row Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Class Distribution -->
        <div class="glass-panel p-6 shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-soft-text flex items-center gap-2">
                    <div class="w-8 h-8 bg-theme-3 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-chart-bar text-sm"></i>
                    </div>
                    แยกตามระดับชั้น
                </h3>
                <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                    ทั้งหมด <span id="total-students">0</span> คน
                </div>
            </div>
            <div class="h-72">
                <canvas id="chartClass"></canvas>
            </div>
        </div>

        <!-- Top Users -->
        <div class="glass-panel p-6 shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-soft-text flex items-center gap-2">
                    <div class="w-8 h-8 bg-theme-4 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-trophy text-sm"></i>
                    </div>
                    Top 10 ผู้ใช้งานสูงสุด
                </h3>
                <div class="text-xs text-gray-500 bg-yellow-100 px-2 py-1 rounded text-yellow-700">
                    <i class="fas fa-crown mr-1"></i> ยอดนิยม
                </div>
            </div>
            <div class="h-72 overflow-y-auto">
                <canvas id="chartTopUsers"></canvas>
            </div>
        </div>
    </div>

    

    <!-- Recent Activity -->
    <div class="glass-panel p-6 shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-soft-text flex items-center gap-2">
                <div class="w-8 h-8 bg-theme-5 rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-history text-sm"></i>
                </div>
                กิจกรรมล่าสุด
            </h3>
            <button onclick="switchPage('database')" class="text-sm text-theme-1 hover:text-theme-2 font-medium flex items-center gap-1">
                ดูทั้งหมด <i class="fas fa-arrow-right text-xs"></i>
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-4 py-3">วันที่</th>
                        <th class="px-4 py-3">ชื่อ-สกุล</th>
                        <th class="px-4 py-3">ระดับชั้น</th>
                        <th class="px-4 py-3">วัตถุประสงค์</th>
                        <th class="px-4 py-3">เวลา</th>
                    </tr>
                </thead>
                <tbody id="recentActivityBody">
                    <!-- Recent activity rows will be injected here -->
                </tbody>
            </table>
            <div id="noRecentActivity" class="hidden p-6 text-center text-gray-400">
                <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
                <p>ยังไม่มีกิจกรรมล่าสุด</p>
            </div>
        </div>
    </div>
</div>

<style>
.gradient-card {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.gradient-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.gradient-card:hover::before {
    left: 100%;
}

.chart-period-btn {
    transition: all 0.3s ease;
}

.chart-period-btn.active {
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.chart-period-btn:not(.active):hover {
    background-color: #f8fafc;
    transform: translateY(-1px);
}

.quick-action-btn {
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
}
</style>



        <!-- PAGE: FORM -->
        <div id="page-form" class="page-section hidden w-full mx-auto">
            <div class="glass-panel p-8 shadow-xl">
                <header class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-theme-1 to-theme-2 text-white rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-soft-text">บันทึกข้อมูลการเข้าใช้</h2>
                    <p class="text-gray-500">กรุณากรอกข้อมูลให้ครบถ้วน</p>
                </header>

                <form id="libraryForm" class="space-y-5" onsubmit="handleFormSubmit(event)">
                    <input type="hidden" id="editId">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่</label>
                            <input type="date" id="inpDate" required class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue focus:border-transparent outline-none bg-white">
                        </div>
                        <div class="flex gap-2">
                             <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">เวลาเข้า</label>
                                <input type="time" id="inpTimeIn" required class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white">
                             </div>
                             <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">เวลาออก</label>
                                <input type="time" id="inpTimeOut" class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white">
                             </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><i class="fas fa-user"></i></span>
                            <input type="text" id="inpName" required placeholder="เช่น นายปฎิโย แพนทาน" class="w-full pl-10 p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue outline-none bg-white">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสนักเรียน/นักศึกษา/ตำแหน่ง</label>
                            <input type="text" id="inpStudentId" placeholder="เช่น 6850020 หรือใส่ ครู" class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">แผนกวิชา-ระดับชั้น-ห้อง</label>
                            <input type="text" id="inpLevel" placeholder="เช่น ทด. ปวช.3/1" class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white">
                            <!-- <select id="inpLevel" required class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white">
                                <option value="">เลือก...</option>
                                <option value="ม.1">ปวช.1</option>
                                <option value="ม.2">ปวช.2</option>
                                <option value="ม.3">ปวช.3</option>
                                <option value="ม.4">ปวส.1</option>
                                <option value="ม.5">ปวส.2</option>
                                <option value="ครู/บุคลากร">ครู/บุคลากร</option>
                            </select> -->
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วัตถุประสงค์</label>
                        <select id="inpPurpose" required class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white">
                            <option value="อ่านหนังสือ">อ่านหนังสือ</option>
                            <option value="ยืม-คืนหนังสือ">ยืม-คืนหนังสือ</option>
                            <option value="ทำการบ้าน/ทำงานกลุ่ม">ทำการบ้าน/ทำงานกลุ่ม</option>
                            <option value="สืบค้นข้อมูล/คอมพิวเตอร์">สืบค้นข้อมูล/คอมพิวเตอร์</option>
                            <option value="พักผ่อน">พักผ่อน</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                        <textarea id="inpNotes" rows="2" class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pastel-blue bg-white"></textarea>
                    </div>

                    <div class="pt-4 flex gap-3">
                        <button type="button" onclick="resetForm()" class="flex-1 py-3 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 font-medium transition-colors">
                            ล้างค่า
                        </button>
                        <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-theme-1 to-theme-2 text-white rounded-lg shadow-md font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i> บันทึกข้อมูล
                        </button>
                    </div>
                </form>
            </div>
        </div>

<!-- PAGE: BORROW/RETURN (USER VIEW) -->
<div id="page-borrow" class="page-section hidden space-y-6">
    <header class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-soft-text flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-r from-theme-1 to-theme-2 rounded-full flex items-center justify-center text-white">
                    <i class="fas fa-book"></i>
                </div>
                ระบบยืม-คืนหนังสือ
            </h2>
            <p class="text-sm text-gray-500 mt-2">กรอกแบบฟอร์มเพื่อขอยืมหนังสือและติดตามสถานะ</p>
        </div>
        <div class="text-right">
            <span class="text-sm font-medium bg-white px-3 py-1 rounded-full shadow-sm text-theme-1" id="currentDateDisplay">
                --/--/----
            </span>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Borrow Form -->
        <div class="lg:col-span-1">
            <div class="glass-panel p-6 sticky top-6 border-l-4 border-theme-1 shadow-lg">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-theme-1 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-file-alt text-sm"></i>
                    </div>
                    <h3 class="text-lg font-bold text-theme-1">แบบฟอร์มขอยืมหนังสือ</h3>
                </div>
                
                <form id="borrowForm" onsubmit="handleBorrowSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-book text-theme-1"></i>
                            ชื่อหนังสือ
                        </label>
                        <input type="text" id="inpBookTitle" required 
                               placeholder="ระบุชื่อหนังสือที่ต้องการยืม..." 
                               class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-1 focus:border-transparent outline-none transition-all duration-200">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-user text-theme-2"></i>
                            ชื่อผู้ยืม
                        </label>
                        <input type="text" id="inpBorrower" required 
                               placeholder="ชื่อ-นามสกุล" 
                               class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-2 focus:border-transparent outline-none transition-all duration-200">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-calendar text-theme-3"></i>
                            วันที่ยืม
                        </label>
                        <input type="date" id="inpDateBorrow" required 
                               class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-3 focus:border-transparent outline-none transition-all duration-200">
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-theme-1 to-theme-2 text-white rounded-lg shadow-md hover:shadow-lg font-medium transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center gap-2">
                        <i class="fas fa-paper-plane"></i>
                        ส่งคำร้องขอยืม
                    </button>
                </form>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs mt-0.5">
                            <i class="fas fa-info"></i>
                        </div>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium">คำแนะนำ</p>
                            <p class="text-xs mt-1">หลังจากส่งคำร้องแล้ว กรุณารอการอนุมัติจากเจ้าหน้าที่ห้องสมุด</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Borrow List (Read Only for Users) -->
        <div class="lg:col-span-2">
            <div class="glass-panel p-6 shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-theme-4 to-theme-5 rounded-full flex items-center justify-center text-white">
                            <i class="fas fa-list text-sm"></i>
                        </div>
                        <h3 class="text-lg font-bold text-soft-text">รายการยืม-คืนล่าสุด</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">ทั้งหมด</span>
                        <span id="borrowCount" class="bg-theme-1 text-white px-2 py-1 rounded-full text-xs font-bold">0</span>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterBorrowTable('all')" class="borrow-filter-btn active bg-theme-1 text-white px-3 py-1 rounded-full text-xs font-medium transition-all duration-200">
                        ทั้งหมด
                    </button>
                    <button onclick="filterBorrowTable('pending')" class="borrow-filter-btn bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-medium transition-all duration-200">
                        รออนุมัติ
                    </button>
                    <button onclick="filterBorrowTable('approved')" class="borrow-filter-btn bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-medium transition-all duration-200">
                        กำลังยืม
                    </button>
                    <button onclick="filterBorrowTable('returned')" class="borrow-filter-btn bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-medium transition-all duration-200">
                        คืนแล้ว
                    </button>
                    <button onclick="filterBorrowTable('rejected')" class="borrow-filter-btn bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-medium transition-all duration-200">
                        ไม่อนุมัติ
                    </button>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-gray-100">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th class="px-4 py-3 font-semibold">วันที่ยืม</th>
                                <th class="px-4 py-3 font-semibold">ชื่อหนังสือ</th>
                                <th class="px-4 py-3 font-semibold">ผู้ยืม</th>
                                <th class="px-4 py-3 font-semibold text-center">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="borrowTableBody" class="divide-y divide-gray-100">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noBorrowData" class="hidden p-8 text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                        <i class="fas fa-book-open text-xl"></i>
                    </div>
                    <p class="text-gray-400 font-medium">ยังไม่มีรายการยืมหนังสือ</p>
                    <p class="text-gray-400 text-sm mt-1">กรุณากรอกแบบฟอร์มด้านซ้ายเพื่อส่งคำร้องขอยืม</p>
                </div>
                
                <!-- Loading State -->
                <div id="borrowLoading" class="hidden p-8 text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-theme-1 mx-auto"></div>
                    <p class="text-gray-400 text-sm mt-2">กำลังโหลดข้อมูล...</p>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <div class="glass-panel p-4 text-center border-t-4 border-yellow-400">
                    <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 mx-auto mb-2">
                        <i class="fas fa-clock text-sm"></i>
                    </div>
                    <p class="text-xs text-gray-500">รออนุมัติ</p>
                    <p class="text-xl font-bold text-gray-700" id="stat-pending-count">0</p>
                </div>
                <div class="glass-panel p-4 text-center border-t-4 border-green-400">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600 mx-auto mb-2">
                        <i class="fas fa-book-reader text-sm"></i>
                    </div>
                    <p class="text-xs text-gray-500">กำลังยืม</p>
                    <p class="text-xl font-bold text-gray-700" id="stat-approved-count">0</p>
                </div>
                <div class="glass-panel p-4 text-center border-t-4 border-gray-400">
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 mx-auto mb-2">
                        <i class="fas fa-check text-sm"></i>
                    </div>
                    <p class="text-xs text-gray-500">คืนแล้ว</p>
                    <p class="text-xl font-bold text-gray-700" id="stat-returned-count">0</p>
                </div>
                <div class="glass-panel p-4 text-center border-t-4 border-red-400">
                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center text-red-600 mx-auto mb-2">
                        <i class="fas fa-times text-sm"></i>
                    </div>
                    <p class="text-xs text-gray-500">ไม่อนุมัติ</p>
                    <p class="text-xl font-bold text-gray-700" id="stat-rejected-count">0</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.borrow-filter-btn {
    transition: all 0.3s ease;
    white-space: nowrap;
}

.borrow-filter-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.borrow-filter-btn.active {
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.status-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.borrow-row {
    transition: all 0.3s ease;
}

.borrow-row:hover {
    background-color: #f8fafc;
    transform: translateX(2px);
}
</style>



<!-- PAGE: ADMIN MANAGEMENT -->
<div id="page-admin" class="page-section hidden space-y-6">
    <!-- Header Section -->
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-r from-theme-7 to-theme-5 rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-user-shield text-xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-soft-text">แผงควบคุมผู้ดูแลระบบ</h2>
                <p class="text-sm text-gray-500">จัดการระบบยืม-คืนหนังสือและข้อมูลทั้งหมด</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <span class="text-sm font-medium bg-white px-3 py-2 rounded-full shadow-sm text-theme-7 border border-gray-100 flex items-center gap-2">
                    <i class="fas fa-user-cog text-theme-5"></i>
                    <span>ผู้ดูแลระบบ</span>
                </span>
            </div>
            <button onclick="handleLogout()" class="bg-gradient-to-r from-theme-5 to-theme-7 text-white px-4 py-2 rounded-lg shadow-sm hover:shadow-md flex items-center gap-2 transition-all duration-200 hover:scale-105">
                <i class="fas fa-sign-out-alt"></i>
                ออกจากระบบ
            </button>
        </div>
    </header>

    <!-- Admin Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Pending Approvals -->
        <div class="gradient-card gradient-card-3 p-5 rounded-xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-clock"></i>
                        รออนุมัติ
                    </p>
                    <h4 class="text-3xl font-bold mt-1" id="admin-stat-pending">0</h4>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-exclamation-circle text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="pending-trend">รอดำเนินการ</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-hourglass-half text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Active Loans -->
        <div class="gradient-card gradient-card-2 p-5 rounded-xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-book-reader"></i>
                        กำลังยืม
                    </p>
                    <h4 class="text-3xl font-bold mt-1" id="admin-stat-active">0</h4>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-book text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="active-trend">หนังสือที่กำลังยืม</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-hand-holding-book text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Returned Today -->
        <div class="gradient-card gradient-card-1 p-5 rounded-xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-check"></i>
                        คืนแล้ว (วันนี้)
                    </p>
                    <h4 class="text-3xl font-bold mt-1" id="admin-stat-returned">0</h4>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-calendar-day text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="returned-trend">คืนในวันนี้</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-undo text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Books -->
        <div class="gradient-card gradient-card-6 p-5 rounded-xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium opacity-90 flex items-center gap-2 mb-1">
                        <i class="fas fa-books"></i>
                        หนังสือทั้งหมด
                    </p>
                    <h4 class="text-3xl font-bold mt-1" id="admin-stat-total">0</h4>
                    <div class="flex items-center gap-1 mt-2">
                        <i class="fas fa-database text-xs opacity-80"></i>
                        <span class="text-xs opacity-80" id="total-trend">รายการในระบบ</span>
                    </div>
                </div>
                <div class="p-3 bg-white/20 rounded-xl text-white">
                    <i class="fas fa-bookmark text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <button onclick="approveAllPending()" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-green-500 group hover:bg-green-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-check-double"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-green-600">อนุมัติทั้งหมด</p>
                    <p class="text-xs text-gray-500">รายการรออนุมัติ</p>
                </div>
            </div>
        </button>

        <button onclick="exportBorrowReport()" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-blue-500 group hover:bg-blue-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-file-export"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-blue-600">รายงานการยืม</p>
                    <p class="text-xs text-gray-500">Export Excel</p>
                </div>
            </div>
        </button>

        <button onclick="showSystemSettings()" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-purple-500 group hover:bg-purple-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-purple-600">ตั้งค่าระบบ</p>
                    <p class="text-xs text-gray-500">การกำหนดค่า</p>
                </div>
            </div>
        </button>

        <button onclick="switchPage('database')" class="glass-panel p-4 rounded-xl hover:shadow-lg transition-all duration-200 border-l-4 border-theme-1 group hover:bg-theme-1/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-theme-1 rounded-lg flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <i class="fas fa-database"></i>
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-theme-1">ฐานข้อมูล</p>
                    <p class="text-xs text-gray-500">จัดการข้อมูล</p>
                </div>
            </div>
        </button>
    </div>

    <!-- Pending Approvals Table -->
    <div class="glass-panel p-6 shadow-lg border-l-4 border-yellow-400">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-bell text-sm"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-yellow-700">รายการรออนุมัติ</h3>
                    <p class="text-sm text-gray-500">คำขอยืมหนังสือที่รอการตรวจสอบ</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">ทั้งหมด</span>
                <span id="pending-count" class="bg-yellow-500 text-white px-2 py-1 rounded-full text-xs font-bold">0</span>
            </div>
        </div>

        <div class="overflow-x-auto rounded-lg border border-yellow-100">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-700 uppercase bg-yellow-50">
                    <tr>
                        <th class="px-4 py-3 font-semibold">วันที่ขอยืม</th>
                        <th class="px-4 py-3 font-semibold">ผู้ยืม</th>
                        <th class="px-4 py-3 font-semibold">ชื่อหนังสือ</th>
                        <th class="px-4 py-3 font-semibold">เวลา</th>
                        <th class="px-4 py-3 font-semibold text-center">การกระทำ</th>
                    </tr>
                </thead>
                <tbody id="adminPendingTable" class="divide-y divide-yellow-50">
                    <!-- Injected JS -->
                </tbody>
            </table>
        </div>
        <div id="noPendingData" class="hidden p-8 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3 text-yellow-500">
                <i class="fas fa-check-circle text-xl"></i>
            </div>
            <p class="text-gray-400 font-medium">ไม่มีรายการรออนุมัติ</p>
            <p class="text-gray-400 text-sm mt-1">ทุกคำขอยืมได้รับการอนุมัติแล้ว</p>
        </div>
    </div>

    <!-- Active Loans Table -->
    <div class="glass-panel p-6 shadow-lg border-l-4 border-green-400">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-hand-holding-book text-sm"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-green-700">รายการที่กำลังยืม</h3>
                    <p class="text-sm text-gray-500">หนังสือที่ยังไม่คืน</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">ทั้งหมด</span>
                <span id="active-count" class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold">0</span>
            </div>
        </div>

        <div class="overflow-x-auto rounded-lg border border-green-100">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-700 uppercase bg-green-50">
                    <tr>
                        <th class="px-4 py-3 font-semibold">วันที่ยืม</th>
                        <th class="px-4 py-3 font-semibold">ผู้ยืม</th>
                        <th class="px-4 py-3 font-semibold">ชื่อหนังสือ</th>
                        <th class="px-4 py-3 font-semibold">ระยะเวลา</th>
                        <th class="px-4 py-3 font-semibold text-center">การจัดการ</th>
                    </tr>
                </thead>
                <tbody id="adminActiveTable" class="divide-y divide-green-50">
                    <!-- Injected JS -->
                </tbody>
            </table>
        </div>
        <div id="noActiveData" class="hidden p-8 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-green-500">
                <i class="fas fa-book-open text-xl"></i>
            </div>
            <p class="text-gray-400 font-medium">ไม่มีรายการที่กำลังยืม</p>
            <p class="text-gray-400 text-sm mt-1">หนังสือทั้งหมดได้คืนแล้ว</p>
        </div>
    </div>

    <!-- System Information -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- System Status -->
        <div class="glass-panel p-6 shadow-lg">
            <h3 class="text-lg font-bold text-soft-text mb-4 flex items-center gap-2">
                <i class="fas fa-server text-theme-1"></i>
                สถานะระบบ
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-600">สถานะฐานข้อมูล</span>
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                        <i class="fas fa-check-circle mr-1"></i> พร้อมใช้งาน
                    </span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-600">การเชื่อมต่อ API</span>
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                        <i class="fas fa-wifi mr-1"></i> ออนไลน์
                    </span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-600">หน่วยความจำใช้งาน</span>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                        64%
                    </span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-600">อัพเดทล่าสุด</span>
                    <span class="text-xs text-gray-500" id="last-update-time">กำลังโหลด...</span>
                </div>
            </div>
        </div>

        <!-- Recent Activity Log -->
        <div class="glass-panel p-6 shadow-lg">
            <h3 class="text-lg font-bold text-soft-text mb-4 flex items-center gap-2">
                <i class="fas fa-history text-theme-2"></i>
                บันทึกกิจกรรมล่าสุด
            </h3>
            <div class="space-y-3 max-h-60 overflow-y-auto">
                <div id="adminActivityLog" class="space-y-2">
                    <!-- Activity logs will be injected here -->
                </div>
                <div id="noActivityLog" class="hidden p-4 text-center text-gray-400 text-sm">
                    <i class="fas fa-inbox text-2xl mb-2 opacity-50"></i>
                    <p>ยังไม่มีบันทึกกิจกรรม</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.admin-table-row {
    transition: all 0.3s ease;
}

.admin-table-row:hover {
    background-color: #f8fafc;
    transform: translateX(2px);
}

.action-btn {
    transition: all 0.3s ease;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.quick-action-btn {
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
}
</style>



<!-- PAGE: DATABASE -->
<div id="page-database" class="page-section hidden space-y-6">
    <!-- Header Section -->
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-r from-theme-10 to-theme-1 rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-database text-xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-soft-text">จัดการฐานข้อมูล</h2>
                <p class="text-sm text-gray-500">ดู จัดการ และส่งออกข้อมูลการใช้งานห้องสมุด</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <span class="text-sm font-medium bg-white px-3 py-2 rounded-full shadow-sm text-theme-10 border border-gray-100 flex items-center gap-2">
                    <i class="fas fa-layer-group text-theme-1"></i>
                    <span>ทั้งหมด <span id="total-records" class="font-bold">0</span> รายการ</span>
                </span>
            </div>
            <button onclick="refreshData()" class="bg-white hover:bg-gray-50 text-theme-10 px-3 py-2 rounded-full shadow-sm border border-gray-100 transition-all duration-200 hover:shadow-md">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="glass-panel p-4 text-center border-t-4 border-theme-1">
            <div class="w-10 h-10 bg-theme-1 rounded-full flex items-center justify-center text-white mx-auto mb-2">
                <i class="fas fa-users"></i>
            </div>
            <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
            <p class="text-xl font-bold text-gray-700" id="stat-total-users">0</p>
        </div>
        <div class="glass-panel p-4 text-center border-t-4 border-theme-2">
            <div class="w-10 h-10 bg-theme-2 rounded-full flex items-center justify-center text-white mx-auto mb-2">
                <i class="fas fa-user-graduate"></i>
            </div>
            <p class="text-xs text-gray-500">นักเรียน</p>
            <p class="text-xl font-bold text-gray-700" id="stat-students">0</p>
        </div>
        <div class="glass-panel p-4 text-center border-t-4 border-theme-3">
            <div class="w-10 h-10 bg-theme-3 rounded-full flex items-center justify-center text-white mx-auto mb-2">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <p class="text-xs text-gray-500">ครู/บุคลากร</p>
            <p class="text-xl font-bold text-gray-700" id="stat-teachers">0</p>
        </div>
        <div class="glass-panel p-4 text-center border-t-4 border-theme-4">
            <div class="w-10 h-10 bg-theme-4 rounded-full flex items-center justify-center text-white mx-auto mb-2">
                <i class="fas fa-calendar-day"></i>
            </div>
            <p class="text-xs text-gray-500">ใช้งานวันนี้</p>
            <p class="text-xl font-bold text-gray-700" id="stat-today-usage">0</p>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="glass-panel p-4 shadow-lg">
        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
            <div class="flex flex-col sm:flex-row gap-3 flex-1 w-full">
                <!-- Search -->
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="searchName" placeholder="ค้นหาชื่อผู้ใช้..." 
                           class="pl-10 w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-1 focus:border-transparent outline-none transition-all duration-200">
                </div>

                <!-- Filters -->
                <div class="flex gap-2 flex-wrap">
                    <select id="filterLevel" class="p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-1 text-sm min-w-32">
                        <option value="">ทุกระดับชั้น</option>
                        <option value="ม.1">ม.1</option>
                        <option value="ม.2">ม.2</option>
                        <option value="ม.3">ม.3</option>
                        <option value="ม.4">ม.4</option>
                        <option value="ม.5">ม.5</option>
                        <option value="ม.6">ม.6</option>
                        <option value="ครู/บุคลากร">ครู/บุคลากร</option>
                    </select>

                    <select id="filterPurpose" class="p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-1 text-sm min-w-40">
                        <option value="">ทุกวัตถุประสงค์</option>
                        <option value="อ่านหนังสือ">อ่านหนังสือ</option>
                        <option value="ยืม-คืนหนังสือ">ยืม-คืนหนังสือ</option>
                        <option value="ทำการบ้าน/ทำงานกลุ่ม">ทำการบ้าน/ทำงานกลุ่ม</option>
                        <option value="สืบค้นข้อมูล/คอมพิวเตอร์">สืบค้นข้อมูล/คอมพิวเตอร์</option>
                        <option value="พักผ่อน">พักผ่อน</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>

                    <input type="date" id="filterDate" class="p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-theme-1 text-sm">
                </div>
            </div>

            <div class="flex gap-2 w-full lg:w-auto">
                <button onclick="resetFilters()" class="flex-1 lg:flex-none bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-3 rounded-lg transition-all duration-200 flex items-center gap-2 justify-center">
                    <i class="fas fa-undo"></i>
                    รีเซ็ต
                </button>
                <button onclick="exportToExcel()" class="flex-1 lg:flex-none bg-gradient-to-r from-theme-2 to-theme-1 hover:from-theme-1 hover:to-theme-2 text-white px-4 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 justify-center">
                    <i class="fas fa-file-excel"></i>
                    Export Excel
                </button>
            </div>
        </div>

        <!-- Active Filters -->
        <div id="activeFilters" class="mt-3 flex flex-wrap gap-2 hidden">
            <!-- Active filters will appear here -->
        </div>
    </div>

    <!-- Data Table -->
    <div class="glass-panel overflow-hidden shadow-lg">
        <!-- Table Header -->
        <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas fa-table text-theme-1"></i>
                    <h3 class="text-lg font-semibold text-gray-700">ข้อมูลการใช้งานห้องสมุด</h3>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-500">แสดง</span>
                    <select id="rowsPerPage" class="text-sm border rounded px-2 py-1" onchange="filterData()">
                        <option value="10">10 รายการ</option>
                        <option value="25">25 รายการ</option>
                        <option value="50">50 รายการ</option>
                        <option value="100">100 รายการ</option>
                    </select>
                    <span class="text-sm text-gray-500" id="showingText">กำลังแสดง 0-0 จาก 0</span>
                </div>
            </div>
        </div>

        <!-- Table Content -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('date')">
                            <div class="flex items-center gap-1">
                                วันที่
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('timeIn')">
                            <div class="flex items-center gap-1">
                                เวลา
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('name')">
                            <div class="flex items-center gap-1">
                                ชื่อ-สกุล
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('level')">
                            <div class="flex items-center gap-1">
                                ระดับชั้น
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('purpose')">
                            <div class="flex items-center gap-1">
                                วัตถุประสงค์
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 font-semibold text-center">หมายเหตุ</th>
                        <th class="px-6 py-4 font-semibold text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="divide-y divide-gray-100">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="hidden p-8 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                <i class="fas fa-database text-xl"></i>
            </div>
            <p class="text-gray-400 font-medium">ไม่พบข้อมูล</p>
            <p class="text-gray-400 text-sm mt-1">ลองเปลี่ยนเงื่อนไขการค้นหาหรือรีเซ็ตตัวกรอง</p>
        </div>

        <!-- Loading State -->
        <div id="tableLoading" class="hidden p-8 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-theme-1 mx-auto"></div>
            <p class="text-gray-400 text-sm mt-2">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Pagination -->
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-500">
                    แสดง <span id="currentPageStart">0</span>-<span id="currentPageEnd">0</span> จาก <span id="totalFilteredRecords">0</span> รายการ
                </div>
                <div class="flex gap-1">
                    <button onclick="changePage('first')" class="p-2 rounded border bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="firstPageBtn">
                        <i class="fas fa-angle-double-left text-xs"></i>
                    </button>
                    <button onclick="changePage('prev')" class="p-2 rounded border bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="prevPageBtn">
                        <i class="fas fa-angle-left text-xs"></i>
                    </button>
                    
                    <div class="flex gap-1" id="pageNumbers">
                        <!-- Page numbers will be injected here -->
                    </div>
                    
                    <button onclick="changePage('next')" class="p-2 rounded border bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="nextPageBtn">
                        <i class="fas fa-angle-right text-xs"></i>
                    </button>
                    <button onclick="changePage('last')" class="p-2 rounded border bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="lastPageBtn">
                        <i class="fas fa-angle-double-right text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="glass-panel p-6 shadow-lg">
        <h3 class="text-lg font-semibold text-soft-text mb-4 flex items-center gap-2">
            <i class="fas fa-tasks text-theme-1"></i>
            การจัดการกลุ่ม
        </h3>
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
            <div class="flex items-center gap-3">
                <input type="checkbox" id="selectAll" class="rounded border-gray-300">
                <label for="selectAll" class="text-sm text-gray-700">เลือกทั้งหมด</label>
                <span class="text-sm text-gray-500" id="selectedCount">0 รายการที่เลือก</span>
            </div>
            <div class="flex gap-2 flex-wrap">
                <button onclick="deleteSelected()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" id="deleteSelectedBtn" disabled>
                    <i class="fas fa-trash"></i>
                    ลบที่เลือก
                </button>
                <button onclick="exportSelected()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" id="exportSelectedBtn" disabled>
                    <i class="fas fa-file-export"></i>
                    ส่งออกที่เลือก
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.table-row {
    transition: all 0.3s ease;
}

.table-row:hover {
    background-color: #f8fafc;
    transform: translateX(2px);
}

.sortable:hover {
    background-color: #f1f5f9;
}

.active-filter {
    background-color: #e0f2fe;
    border-color: #0ea5e9;
}

.page-btn.active {
    background-color: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.bulk-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>



    </main>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwKX6rrVrUgWOesqnxYGIAwXgroRybcwrRaXKCX5LF8F_7ZryuKBArLevZH4kywHaL87g/exec'; 
        // เปลี่ยนเป็น true เพื่อป้องกัน Error "Failed to fetch" หากยังไม่ได้ Deploy หรือเชื่อมต่อไม่ได้
        let USE_MOCK_DATA = false; 

        let allData = [];
        let borrowData = [];
        let isAdminLoggedIn = false;
        let charts = {};


     // ตัวแปรสำหรับจัดการแผนภูมิ
let chartPeriod = 'week';

// ตัวแปรสำหรับจัดการตาราง
let currentPage = 1;
let rowsPerPage = 10;
let currentSort = { column: 'date', direction: 'desc' };
let selectedRows = new Set();

// ฟังก์ชันเรียงลำดับตาราง
function sortTable(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    filterData();
}

// ฟังก์ชันเปลี่ยนหน้า
function changePage(action) {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    
    switch(action) {
        case 'first':
            currentPage = 1;
            break;
        case 'prev':
            if (currentPage > 1) currentPage--;
            break;
        case 'next':
            if (currentPage < totalPages) currentPage++;
            break;
        case 'last':
            currentPage = totalPages;
            break;
        default:
            if (action >= 1 && action <= totalPages) {
                currentPage = action;
            }
    }
    
    renderTable(filteredData);
}

// ฟังก์ชันเลือกทั้งหมด
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    
    if (selectAll.checked) {
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            selectedRows.add(checkbox.value);
        });
    } else {
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            selectedRows.delete(checkbox.value);
        });
    }
    
    updateSelectedCount();
}

// ฟังก์ชันอัพเดทจำนวนที่เลือก
function updateSelectedCount() {
    const count = selectedRows.size;
    document.getElementById('selectedCount').textContent = `${count} รายการที่เลือก`;
    
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const exportBtn = document.getElementById('exportSelectedBtn');
    
    deleteBtn.disabled = count === 0;
    exportBtn.disabled = count === 0;
}

// ฟังก์ชันเลือกรายการ
function toggleRowSelection(id) {
    if (selectedRows.has(id)) {
        selectedRows.delete(id);
    } else {
        selectedRows.add(id);
    }
    updateSelectedCount();
}

// ฟังก์ชันลบรายการที่เลือก
function deleteSelected() {
    if (selectedRows.size === 0) return;
    
    Swal.fire({
        title: 'ยืนยันการลบ',
        text: `คุณต้องการลบ ${selectedRows.size} รายการที่เลือกหรือไม่?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#ef5350'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Simulate API calls
            const promises = Array.from(selectedRows).map(id => 
                deleteData(id)
            );

            Promise.all(promises).then(() => {
                selectedRows.clear();
                updateSelectedCount();
                Swal.fire('สำเร็จ', `ลบ ${selectedRows.size} รายการเรียบร้อย`, 'success');
                fetchData();
            }).catch(error => {
                Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการลบ', 'error');
            }).finally(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }
    });
}

// ฟังก์ชันส่งออกรายการที่เลือก
function exportSelected() {
    if (selectedRows.size === 0) return;
    
    const selectedData = allData.filter(item => selectedRows.has(item.id));
    const ws = XLSX.utils.json_to_sheet(selectedData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ข้อมูลที่เลือก');
    XLSX.writeFile(wb, `ข้อมูลที่เลือก_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ฟังก์ชันกรองข้อมูล
let filteredData = [];

function filterData() {
    const searchTerm = document.getElementById('searchName').value.toLowerCase();
    const levelFilter = document.getElementById('filterLevel').value;
    const purposeFilter = document.getElementById('filterPurpose').value;
    const dateFilter = document.getElementById('filterDate').value;
    rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
    
    // กรองข้อมูล
    filteredData = allData.filter(item => {
        const matchesSearch = item.name.toLowerCase().includes(searchTerm);
        const matchesLevel = !levelFilter || item.level === levelFilter;
        const matchesPurpose = !purposeFilter || item.purpose === purposeFilter;
        const matchesDate = !dateFilter || item.date === dateFilter;
        
        return matchesSearch && matchesLevel && matchesPurpose && matchesDate;
    });
    
    // เรียงลำดับ
    filteredData.sort((a, b) => {
        let aValue = a[currentSort.column];
        let bValue = b[currentSort.column];
        
        if (currentSort.column === 'date') {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        }
        
        if (currentSort.direction === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    currentPage = 1;
    renderTable(filteredData);
    updateActiveFilters();
    updateDatabaseStats();
}

// อัพเดทตัวกรองที่ใช้งาน
function updateActiveFilters() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const searchTerm = document.getElementById('searchName').value;
    const levelFilter = document.getElementById('filterLevel').value;
    const purposeFilter = document.getElementById('filterPurpose').value;
    const dateFilter = document.getElementById('filterDate').value;
    
    let activeFilters = [];
    
    if (searchTerm) {
        activeFilters.push({
            type: 'search',
            text: `ค้นหา: "${searchTerm}"`,
            clear: () => document.getElementById('searchName').value = ''
        });
    }
    
    if (levelFilter) {
        activeFilters.push({
            type: 'level',
            text: `ระดับชั้น: ${levelFilter}`,
            clear: () => document.getElementById('filterLevel').value = ''
        });
    }
    
    if (purposeFilter) {
        activeFilters.push({
            type: 'purpose',
            text: `วัตถุประสงค์: ${purposeFilter}`,
            clear: () => document.getElementById('filterPurpose').value = ''
        });
    }
    
    if (dateFilter) {
        activeFilters.push({
            type: 'date',
            text: `วันที่: ${formatThaiDate(dateFilter)}`,
            clear: () => document.getElementById('filterDate').value = ''
        });
    }
    
    if (activeFilters.length > 0) {
        activeFiltersDiv.classList.remove('hidden');
        activeFiltersDiv.innerHTML = activeFilters.map(filter => `
            <span class="active-filter px-3 py-1 rounded-full text-xs font-medium text-theme-1 border border-theme-1 flex items-center gap-1">
                ${filter.text}
                <button onclick="${filter.clear.toString().replace(/\"/g, '&quot;')}; filterData();" class="hover:text-theme-7">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `).join('');
    } else {
        activeFiltersDiv.classList.add('hidden');
    }
}

// อัพเดทสถิติฐานข้อมูล
function updateDatabaseStats() {
    const today = new Date().toISOString().split('T')[0];
    
    const totalUsers = new Set(allData.map(item => item.name)).size;
    const students = allData.filter(item => item.level !== 'ครู/บุคลากร').length;
    const teachers = allData.filter(item => item.level === 'ครู/บุคลากร').length;
    const todayUsage = allData.filter(item => item.date === today).length;
    
    document.getElementById('total-records').textContent = allData.length;
    document.getElementById('stat-total-users').textContent = totalUsers;
    document.getElementById('stat-students').textContent = students;
    document.getElementById('stat-teachers').textContent = teachers;
    document.getElementById('stat-today-usage').textContent = todayUsage;
}



// ฟังก์ชันเปลี่ยนช่วงเวลาของแผนภูมิ
function changeChartPeriod(period) {
    chartPeriod = period;
    
    // อัพเดทปุ่ม
    document.querySelectorAll('.chart-period-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-theme-1', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-600');
    });
    event.target.classList.add('active', 'bg-theme-1', 'text-white');
    event.target.classList.remove('bg-gray-100', 'text-gray-600');
    
    // อัพเดทแผนภูมิ
    updateDashboard(allData);
}
   

// ฟังก์ชันสำหรับกรองตาราง
let currentBorrowFilter = 'all';

function filterBorrowTable(status) {
    currentBorrowFilter = status;
    
    // อัพเดทปุ่ม filter
    document.querySelectorAll('.borrow-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderBorrowTable();
}

        // --- CORE FUNCTIONS ---
        async function callAPI(payload) {
            // Check mock first
            if (USE_MOCK_DATA) return mockAPI(payload);
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (!res.ok) throw new Error('Network response was not ok');
                const json = await res.json();
                if (json.status !== 'success') throw new Error(json.message);
                return json;
            } catch (e) {
                console.warn("API Connection Failed, switching to Mock Data:", e);
                USE_MOCK_DATA = true; // Fallback to mock
                Swal.fire({
                    icon: 'warning',
                    title: 'เชื่อมต่อ Google Sheet ไม่สำเร็จ',
                    text: 'ระบบจะสลับไปใช้โหมดจำลองข้อมูล (Mock Data) แทนชั่วคราว',
                    timer: 2000,
                    showConfirmButton: false
                });
                return mockAPI(payload);
            }
        }

        async function fetchData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                if (USE_MOCK_DATA) {
                    await new Promise(r => setTimeout(r, 800));
                    allData = generateMockData();
                    initBorrowData(); // Load Mock borrow data
                    updateStatus("Offline (Mock Data)", "yellow");
                } else {
                    try {
                        // 1. Fetch Stats Data
                        const responseStats = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'read' })
                        });
                        const resultStats = await responseStats.json();
                        if (resultStats.status === 'success') {
                            allData = resultStats.data;
                        }

                        // 2. Fetch Borrow Data (แก้ไขเพิ่มส่วนนี้เพื่อดึงข้อมูลยืมคืนจริง)
                        const responseBorrow = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'borrow_read' })
                        });
                        const resultBorrow = await responseBorrow.json();
                        if (resultBorrow.status === 'success') {
                            borrowData = resultBorrow.data;
                        }

                        updateStatus("Online (Google Sheet)", "green");
                    } catch(err) {
                        console.error("Fetch Error:", err);
                        // Fallback logic handled by callAPI usually, but here specific manual fetch
                        USE_MOCK_DATA = true;
                        allData = generateMockData();
                        initBorrowData();
                        updateStatus("Connection Failed", "red");
                    }
                }
                
                // Render everything
                renderTable(allData);
                updateDashboard(allData);
                renderBorrowTable();
                if (isAdminLoggedIn) renderAdminDashboard();
                
            } catch (e) {
                console.error("Critical Error in fetchData:", e);
                Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้', 'error');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const payload = {
                action: id ? 'edit' : 'create',
                id: id,
                date: document.getElementById('inpDate').value,
                timeIn: document.getElementById('inpTimeIn').value,
                timeOut: document.getElementById('inpTimeOut').value,
                name: document.getElementById('inpName').value,
                studentId: document.getElementById('inpStudentId').value,
                level: document.getElementById('inpLevel').value,
                purpose: document.getElementById('inpPurpose').value,
                notes: document.getElementById('inpNotes').value
            };
            
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                await callAPI(payload);
                Swal.fire('สำเร็จ', 'บันทึกข้อมูลแล้ว', 'success');
                document.getElementById('libraryForm').reset();
                document.getElementById('editId').value = '';
                fetchData();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            finally { document.getElementById('loadingOverlay').style.display = 'none'; }
        }

       async function handleBorrowSubmit(e) {
    e.preventDefault();
    const book = document.getElementById('inpBookTitle').value;
    const borrower = document.getElementById('inpBorrower').value;
    const date = document.getElementById('inpDateBorrow').value;

    const payload = {
        action: 'borrow_create',
        date: date,
        book: book,
        borrower: borrower
    };

    document.getElementById('loadingOverlay').style.display = 'flex';

    try {
        if (USE_MOCK_DATA) {
            // Mock Logic
            const newItem = {
                id: 'b_' + Date.now(),
                date: date,
                book: book,
                borrower: borrower,
                status: 'pending'
            };
            borrowData.unshift(newItem);
            localStorage.setItem('borrowData', JSON.stringify(borrowData));
        } else {
            // Real API Logic
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
        }

        Swal.fire({
            icon: 'success',
            title: 'ส่งคำร้องสำเร็จ',
            text: 'กรุณารอเจ้าหน้าที่อนุมัติ',
            timer: 1500,
            showConfirmButton: false
        });

        document.getElementById('borrowForm').reset();
        document.getElementById('inpDateBorrow').value = new Date().toISOString().split('T')[0];
        
        // Refresh data and UI
        if (!USE_MOCK_DATA) {
            fetchData(); 
        } else {
            renderBorrowTable();
            if (isAdminLoggedIn) renderAdminDashboard();
        }

    } catch (error) {
         Swal.fire('ข้อผิดพลาด', error.message, 'error');
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function approveAllPending() {
    const pendingItems = borrowData.filter(d => d.status === 'pending');
    if (pendingItems.length === 0) {
        Swal.fire('แจ้งเตือน', 'ไม่มีรายการรออนุมัติ', 'info');
        return;
    }

    Swal.fire({
        title: 'อนุมัติทั้งหมด?',
        text: `คุณต้องการอนุมัติ ${pendingItems.length} รายการรออนุมัติทั้งหมดหรือไม่?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'อนุมัติทั้งหมด',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Simulate API calls
            const promises = pendingItems.map(item => 
                updateBorrowStatus(item.id, 'approved')
            );

            Promise.all(promises).then(() => {
                Swal.fire('สำเร็จ', `อนุมัติ ${pendingItems.length} รายการเรียบร้อย`, 'success');
                renderAdminDashboard();
            }).catch(error => {
                Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการอนุมัติ', 'error');
            }).finally(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }
    });
}
function exportBorrowReport() {
    Swal.fire({
        title: 'กำลังสร้างรายงาน',
        text: 'ระบบกำลังสร้างรายงานการยืม-คืนหนังสือ...',
        icon: 'info',
        showConfirmButton: false,
        timer: 1500
    }).then(() => {
        // สร้างข้อมูลสำหรับ Excel
        const reportData = borrowData.map(item => ({
            'วันที่': item.date,
            'ชื่อหนังสือ': item.book,
            'ผู้ยืม': item.borrower,
            'สถานะ': getStatusText(item.status),
            'วันที่สร้าง': new Date().toLocaleDateString('th-TH')
        }));

        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'รายงานการยืม');
        XLSX.writeFile(wb, `รายงานการยืม-คืน_${new Date().toISOString().split('T')[0]}.xlsx`);
    });
}

function showSystemSettings() {
    Swal.fire({
        title: 'ตั้งค่าระบบ',
        html: `
            <div class="text-left space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ระยะเวลายืมสูงสุด (วัน)</label>
                    <input type="number" value="7" class="w-full p-2 border rounded-lg" min="1" max="30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนหนังสือที่ยืมได้สูงสุด</label>
                    <input type="number" value="3" class="w-full p-2 border rounded-lg" min="1" max="10">
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" class="rounded" checked>
                        <span class="ml-2 text-sm text-gray-700">ส่งการแจ้งเตือนอัตโนมัติ</span>
                    </label>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'บันทึกการตั้งค่า',
        cancelButtonText: 'ยกเลิก'
    });
}
function getStatusText(status) {
    const statusMap = {
        'pending': 'รออนุมัติ',
        'approved': 'กำลังยืม',
        'returned': 'คืนแล้ว',
        'rejected': 'ไม่อนุมัติ'
    };
    return statusMap[status] || 'ไม่ทราบสถานะ';
}

function calculateLoanDuration(borrowDate) {
    const today = new Date();
    const borrow = new Date(borrowDate);
    const diffTime = Math.abs(today - borrow);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return `${diffDays} วัน`;
}
        async function updateBorrowStatus(id, newStatus) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                if (USE_MOCK_DATA) {
                    // Mock Logic
                    const item = borrowData.find(d => d.id === id);
                    if (item) {
                        item.status = newStatus;
                        localStorage.setItem('borrowData', JSON.stringify(borrowData));
                    }
                } else {
                    // Real API Logic (แก้ไขให้เรียก API จริง)
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'borrow_update', id: id, status: newStatus })
                    });
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message);
                }

                // Refresh UI
                if (!USE_MOCK_DATA) {
                    fetchData();
                } else {
                    renderBorrowTable();
                    renderAdminDashboard();
                }
                
                const statusText = newStatus === 'approved' ? 'อนุมัติแล้ว' : (newStatus === 'rejected' ? 'ไม่อนุมัติ' : 'คืนหนังสือแล้ว');
                const icon = newStatus === 'approved' ? 'success' : (newStatus === 'rejected' ? 'error' : 'info');
                
                Swal.fire({
                    icon: icon,
                    title: statusText,
                    timer: 1000,
                    showConfirmButton: false
                });

            } catch(e) { 
                Swal.fire('Error', e.message, 'error'); 
            } finally { 
                document.getElementById('loadingOverlay').style.display = 'none'; 
            }
        }

        async function deleteData(id) {
            if(!confirm('ลบข้อมูลนี้?')) return;
            try {
                await callAPI({ action: 'delete', id: id });
                fetchData();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        // --- RENDER UI ---
        function renderBorrowUI() { /* Removed (Combined logic into renderBorrowTable) */ }

        // User View Table
       function renderBorrowTable() {
    const tbody = document.getElementById('borrowTableBody');
    const noDataDiv = document.getElementById('noBorrowData');
    const loadingDiv = document.getElementById('borrowLoading');
    
    // แสดง loading
    tbody.innerHTML = '';
    noDataDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
    
    setTimeout(() => {
        loadingDiv.classList.add('hidden');
        
        let filteredData = borrowData;
        if (currentBorrowFilter !== 'all') {
            filteredData = borrowData.filter(item => item.status === currentBorrowFilter);
        }
        
        // เรียงลำดับข้อมูลล่าสุดขึ้นก่อน
        filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (filteredData.length === 0) {
            noDataDiv.classList.remove('hidden');
            tbody.innerHTML = '';
        } else {
            noDataDiv.classList.add('hidden');
            
            filteredData.forEach((r, index) => {
                let badgeClass, badgeIcon, badgeText;
                
                switch(r.status) {
                    case 'pending':
                        badgeClass = 'bg-yellow-100 text-yellow-800';
                        badgeIcon = 'fas fa-clock';
                        badgeText = 'รออนุมัติ';
                        break;
                    case 'approved':
                        badgeClass = 'bg-green-100 text-green-800';
                        badgeIcon = 'fas fa-book-reader';
                        badgeText = 'กำลังยืม';
                        break;
                    case 'returned':
                        badgeClass = 'bg-gray-100 text-gray-600';
                        badgeIcon = 'fas fa-check';
                        badgeText = 'คืนแล้ว';
                        break;
                    case 'rejected':
                        badgeClass = 'bg-red-100 text-red-800';
                        badgeIcon = 'fas fa-times';
                        badgeText = 'ไม่อนุมัติ';
                        break;
                    default:
                        badgeClass = 'bg-gray-100 text-gray-600';
                        badgeIcon = 'fas fa-question';
                        badgeText = 'ไม่ทราบสถานะ';
                }
                
                const tr = document.createElement('tr');
                tr.className = "borrow-row";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-700">${formatThaiDate(r.date)}</td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-800">${r.book}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium">${r.borrower}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="status-badge ${badgeClass}">
                            <i class="${badgeIcon} text-xs"></i>
                            ${badgeText}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // อัพเดทสถิติ
        updateBorrowStats();
    }, 500);
}

function updateBorrowStats() {
    const pendingCount = borrowData.filter(d => d.status === 'pending').length;
    const approvedCount = borrowData.filter(d => d.status === 'approved').length;
    const returnedCount = borrowData.filter(d => d.status === 'returned').length;
    const rejectedCount = borrowData.filter(d => d.status === 'rejected').length;
    
    document.getElementById('stat-pending-count').innerText = pendingCount;
    document.getElementById('stat-approved-count').innerText = approvedCount;
    document.getElementById('stat-returned-count').innerText = returnedCount;
    document.getElementById('stat-rejected-count').innerText = rejectedCount;
    document.getElementById('borrowCount').innerText = borrowData.length;
}

// ฟังก์ชันจัดรูปแบบวันที่ไทย
function formatThaiDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('th-TH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

        // --- ADDED: Missing Admin Render Function ---
        function renderAdminDashboard() {
    // คำนวณสถิติ
    const pendingCount = borrowData.filter(d => d.status === 'pending').length;
    const activeCount = borrowData.filter(d => d.status === 'approved').length;
    const returnedToday = borrowData.filter(d => d.status === 'returned' && d.date === new Date().toISOString().split('T')[0]).length;
    const totalBooks = borrowData.length;

    // อัพเดทการ์ดสถิติ
    document.getElementById('admin-stat-pending').innerText = pendingCount;
    document.getElementById('admin-stat-active').innerText = activeCount;
    document.getElementById('admin-stat-returned').innerText = returnedToday;
    document.getElementById('admin-stat-total').innerText = totalBooks;

    // อัพเดทจำนวนทั้งหมด
    document.getElementById('pending-count').innerText = pendingCount;
    document.getElementById('active-count').innerText = activeCount;

    // Render Pending Table
    const pendingTbody = document.getElementById('adminPendingTable');
    const noPendingDiv = document.getElementById('noPendingData');
    
    if (pendingTbody) {
        pendingTbody.innerHTML = '';
        const pendingItems = borrowData.filter(d => d.status === 'pending');
        
        if (pendingItems.length === 0) {
            noPendingDiv.classList.remove('hidden');
        } else {
            noPendingDiv.classList.add('hidden');
            pendingItems.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "admin-table-row bg-white";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${formatThaiDate(row.date)}</td>
                    <td class="px-4 py-3">
                        <div class="font-bold text-gray-700">${row.borrower}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-gray-600">${row.book}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="updateBorrowStatus('${row.id}', 'approved')" class="action-btn bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-xs font-medium transition-all flex items-center gap-1">
                                <i class="fas fa-check"></i> อนุมัติ
                            </button>
                            <button onclick="updateBorrowStatus('${row.id}', 'rejected')" class="action-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs font-medium transition-all flex items-center gap-1">
                                <i class="fas fa-times"></i> ปฏิเสธ
                            </button>
                        </div>
                    </td>
                `;
                pendingTbody.appendChild(tr);
            });
        }
    }

    // Render Active Loans Table
    const activeTbody = document.getElementById('adminActiveTable');
    const noActiveDiv = document.getElementById('noActiveData');
    
    if (activeTbody) {
        activeTbody.innerHTML = '';
        const activeItems = borrowData.filter(d => d.status === 'approved');

        if (activeItems.length === 0) {
            noActiveDiv.classList.remove('hidden');
        } else {
            noActiveDiv.classList.add('hidden');
            activeItems.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "admin-table-row bg-white";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${formatThaiDate(row.date)}</td>
                    <td class="px-4 py-3">
                        <div class="font-bold text-gray-700">${row.borrower}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-gray-600">${row.book}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${calculateLoanDuration(row.date)}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="updateBorrowStatus('${row.id}', 'returned')" class="action-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-xs font-medium transition-all flex items-center gap-1 mx-auto">
                            <i class="fas fa-undo mr-1"></i> แจ้งคืน
                        </button>
                    </td>
                `;
                activeTbody.appendChild(tr);
            });
        }
    }

    // อัพเดทเวลาล่าสุด
    document.getElementById('last-update-time').textContent = new Date().toLocaleString('th-TH');
    
    // อัพเดทบันทึกกิจกรรม
    updateActivityLog();
}

function updateActivityLog() {
    const activityLog = document.getElementById('adminActivityLog');
    const noActivityDiv = document.getElementById('noActivityLog');
    
    // ตัวอย่างบันทึกกิจกรรม
    const activities = [
        { time: '10:30', action: 'อนุมัติคำขอยืมหนังสือ', user: 'สมชาย ใจดี', book: 'วิทยาศาสตร์ ม.1' },
        { time: '09:15', action: 'รับคืนหนังสือ', user: 'มานี มีตา', book: 'แฮร์รี่ พอตเตอร์' },
        { time: '08:45', action: 'ปฏิเสธคำขอยืม', user: 'John Doe', book: 'คณิตศาสตร์ขั้นสูง' }
    ];
    
    if (activities.length === 0) {
        activityLog.innerHTML = '';
        noActivityDiv.classList.remove('hidden');
        return;
    }
    
    noActivityDiv.classList.add('hidden');
    activityLog.innerHTML = '';
    
    activities.forEach(activity => {
        const div = document.createElement('div');
        div.className = 'flex items-start gap-3 p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
            <div class="w-2 h-2 bg-theme-1 rounded-full mt-2 flex-shrink-0"></div>
            <div class="flex-1">
                <div class="flex justify-between items-start">
                    <span class="text-sm font-medium text-gray-700">${activity.action}</span>
                    <span class="text-xs text-gray-500">${activity.time}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    ${activity.user} - ${activity.book}
                </div>
            </div>
        `;
        activityLog.appendChild(div);
    });
}

       function renderTable(data) {
    const tbody = document.getElementById('dataTableBody');
    const noDataDiv = document.getElementById('noDataMessage');
    const loadingDiv = document.getElementById('tableLoading');
    const totalFilteredRecords = document.getElementById('totalFilteredRecords');
    
    // แสดง loading
    tbody.innerHTML = '';
    noDataDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
    
    setTimeout(() => {
        loadingDiv.classList.add('hidden');
        
        if (data.length === 0) {
            noDataDiv.classList.remove('hidden');
            totalFilteredRecords.textContent = '0';
            updatePagination(0);
            return;
        }
        
        totalFilteredRecords.textContent = data.length.toLocaleString();
        
        // คำนวณ pagination
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, data.length);
        const pageData = data.slice(startIndex, endIndex);
        
        tbody.innerHTML = '';
        
        pageData.forEach((r, index) => {
            const isSelected = selectedRows.has(r.id);
            const rowNumber = startIndex + index + 1;
            
            const tr = document.createElement('tr');
            tr.className = `table-row ${isSelected ? 'bg-blue-50' : 'bg-white'}`;
            tr.innerHTML = `
                <td class="px-6 py-4 font-medium">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="row-checkbox rounded border-gray-300" 
                               value="${r.id}" ${isSelected ? 'checked' : ''} 
                               onchange="toggleRowSelection('${r.id}')">
                        ${formatThaiDate(r.date)}
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center gap-1 text-sm">
                        <span class="text-green-600">${r.timeIn || '-'}</span>
                        <span class="text-gray-300">-</span>
                        <span class="text-red-600">${r.timeOut || '-'}</span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="font-medium text-gray-800">${r.name}</div>
                    ${r.studentId ? `<div class="text-xs text-gray-500">${r.studentId}</div>` : ''}
                </td>
                <td class="px-6 py-4">
                    <span class="level-badge ${getLevelBadgeClass(r.level)}">${r.level}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="purpose-badge ${getPurposeBadgeClass(r.purpose)}">${r.purpose}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    ${r.notes ? `
                        <button onclick="showNotes('${r.notes.replace(/'/g, "\\'")}')" 
                                class="text-theme-1 hover:text-theme-2 transition-colors">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                    ` : '<span class="text-gray-400">-</span>'}
                </td>
                <td class="px-6 py-4 text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="editData('${r.id}')" 
                                class="text-blue-600 hover:text-blue-800 transition-colors p-2 rounded hover:bg-blue-50"
                                title="แก้ไข">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteData('${r.id}')" 
                                class="text-red-600 hover:text-red-800 transition-colors p-2 rounded hover:bg-red-50"
                                title="ลบ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        updatePagination(data.length);
        
    }, 500);
}
// ฟังก์ชันอัพเดท pagination
function updatePagination(totalRecords) {
    const totalPages = Math.ceil(totalRecords / rowsPerPage);
    const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
    const endRecord = Math.min(currentPage * rowsPerPage, totalRecords);
    
    document.getElementById('currentPageStart').textContent = startRecord.toLocaleString();
    document.getElementById('currentPageEnd').textContent = endRecord.toLocaleString();
    document.getElementById('showingText').textContent = `กำลังแสดง ${startRecord}-${endRecord} จาก ${totalRecords.toLocaleString()}`;
    
    // อัพเดทปุ่ม pagination
    document.getElementById('firstPageBtn').disabled = currentPage === 1;
    document.getElementById('prevPageBtn').disabled = currentPage === 1;
    document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
    document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
    
    // สร้างเลขหน้า
    const pageNumbersDiv = document.getElementById('pageNumbers');
    pageNumbersDiv.innerHTML = '';
    
    const maxPagesToShow = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
    
    if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.className = `p-2 rounded border min-w-10 ${
            i === currentPage ? 'page-btn active bg-theme-1 text-white' : 'bg-white hover:bg-gray-50'
        }`;
        button.textContent = i;
        button.onclick = () => changePage(i);
        pageNumbersDiv.appendChild(button);
    }
}

// ฟังก์ชัน helper สำหรับ badge classes
function getLevelBadgeClass(level) {
    const classMap = {
        'ม.1': 'bg-blue-100 text-blue-800',
        'ม.2': 'bg-green-100 text-green-800',
        'ม.3': 'bg-yellow-100 text-yellow-800',
        'ม.4': 'bg-purple-100 text-purple-800',
        'ม.5': 'bg-pink-100 text-pink-800',
        'ม.6': 'bg-indigo-100 text-indigo-800',
        'ครู/บุคลากร': 'bg-gray-100 text-gray-800'
    };
    return classMap[level] || 'bg-gray-100 text-gray-800';
}

function getPurposeBadgeClass(purpose) {
    const classMap = {
        'อ่านหนังสือ': 'bg-blue-50 text-blue-700 border border-blue-200',
        'ยืม-คืนหนังสือ': 'bg-green-50 text-green-700 border border-green-200',
        'ทำการบ้าน/ทำงานกลุ่ม': 'bg-yellow-50 text-yellow-700 border border-yellow-200',
        'สืบค้นข้อมูล/คอมพิวเตอร์': 'bg-purple-50 text-purple-700 border border-purple-200',
        'พักผ่อน': 'bg-gray-50 text-gray-700 border border-gray-200',
        'อื่นๆ': 'bg-orange-50 text-orange-700 border border-orange-200'
    };
    return classMap[purpose] || 'bg-gray-50 text-gray-700 border border-gray-200';
}

// ฟังก์ชันแสดงหมายเหตุ
function showNotes(notes) {
    Swal.fire({
        title: 'หมายเหตุ',
        text: notes,
        icon: 'info',
        confirmButtonText: 'ปิด'
    });
}

// ฟังก์ชันแก้ไขข้อมูล
function editData(id) {
    const item = allData.find(d => d.id === id);
    if (!item) return;
    
    // เติมข้อมูลในฟอร์ม
    document.getElementById('editId').value = item.id;
    document.getElementById('inpDate').value = item.date;
    document.getElementById('inpTimeIn').value = item.timeIn;
    document.getElementById('inpTimeOut').value = item.timeOut;
    document.getElementById('inpName').value = item.name;
    document.getElementById('inpStudentId').value = item.studentId || '';
    document.getElementById('inpLevel').value = item.level;
    document.getElementById('inpPurpose').value = item.purpose;
    document.getElementById('inpNotes').value = item.notes || '';
    
    // เปลี่ยนไปหน้าฟอร์ม
    switchPage('form');
    
    // Scroll to top
    window.scrollTo(0, 0);
}

// ฟังก์ชันรีเซ็ตตัวกรอง
function resetFilters() {
    document.getElementById('searchName').value = '';
    document.getElementById('filterLevel').value = '';
    document.getElementById('filterPurpose').value = '';
    document.getElementById('filterDate').value = '';
    document.getElementById('rowsPerPage').value = '10';
    document.getElementById('selectAll').checked = false;
    
    selectedRows.clear();
    updateSelectedCount();
    
    filterData();
}

// อัพเดทเมื่อโหลดหน้า
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
    
    // Add event listeners for filters
    document.getElementById('searchName').addEventListener('input', filterData);
    document.getElementById('filterLevel').addEventListener('change', filterData);
    document.getElementById('filterPurpose').addEventListener('change', filterData);
    document.getElementById('filterDate').addEventListener('change', filterData);
});


        // ในส่วนของฟังก์ชัน updateDashboard(data)
function updateDashboard(data) {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = today.substring(0, 7);
    const countToday = data.filter(d => d.date === today).length;
    const countMonth = data.filter(d => d.date.startsWith(currentMonth)).length;

    document.getElementById('stat-today').innerText = countToday;
    document.getElementById('stat-month').innerText = countMonth;

    // คำนวณสถิติ
    const levelCounts = {};
    const purposeCounts = {};
    const userCounts = {};
    
    data.forEach(d => {
        levelCounts[d.level] = (levelCounts[d.level] || 0) + 1;
        purposeCounts[d.purpose] = (purposeCounts[d.purpose] || 0) + 1;
        userCounts[d.name] = (userCounts[d.name] || 0) + 1;
    });

    // หาระดับชั้นและวัตถุประสงค์ยอดนิยม
    const topLevel = Object.entries(levelCounts).sort((a,b) => b[1] - a[1])[0];
    const topPurpose = Object.entries(purposeCounts).sort((a,b) => b[1] - a[1])[0];
    
    document.getElementById('stat-top-class').innerText = topLevel ? topLevel[0] : '-';
    document.getElementById('stat-top-purpose').innerText = topPurpose ? topPurpose[0] : '-';
    
    // อัพเดทข้อมูลเพิ่มเติม
    document.getElementById('top-class-count').innerText = topLevel ? `${topLevel[1]} คน` : '0 คน';
    document.getElementById('top-purpose-count').innerText = topPurpose ? `${topPurpose[1]} ครั้ง` : '0 ครั้ง';
    document.getElementById('total-students').innerText = data.length;

    // คำนวณแนวโน้ม
    calculateTrends(data);

    // สร้างแผนภูมิ - ส่งข้อมูล levelCounts และ purposeCounts ไปด้วย
    renderCharts(data, levelCounts, purposeCounts, userCounts);
    
    // แสดงกิจกรรมล่าสุด
    renderRecentActivity(data);
}

// ฟังก์ชันคำนวณแนวโน้ม
function calculateTrends(data) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const todayStr = today.toISOString().split('T')[0];
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    const todayCount = data.filter(d => d.date === todayStr).length;
    const yesterdayCount = data.filter(d => d.date === yesterdayStr).length;
    
    let todayTrend = '+0%';
    if (yesterdayCount > 0) {
        const change = ((todayCount - yesterdayCount) / yesterdayCount) * 100;
        todayTrend = `${change >= 0 ? '+' : ''}${change.toFixed(1)}% จากเมื่อวาน`;
    }
    
    document.getElementById('today-trend').innerText = todayTrend;
    document.getElementById('month-trend').innerText = '+12.5% จากเดือนที่แล้ว'; // ตัวอย่างข้อมูล
}


// ฟังก์ชันสร้างแผนภูมิ
function renderCharts(data, levelCounts, purposeCounts, userCounts) {
    // แผนภูมิรายวัน
    const dailyLabels = chartPeriod === 'week' ? getLast7Days() : getLast30Days();
    const dailyData = dailyLabels.map(day => {
        return data.filter(d => d.date === day).length;
    });
    
    const ctx1 = document.getElementById('chartDaily').getContext('2d');
    if(charts.daily) charts.daily.destroy();
    
    charts.daily = new Chart(ctx1, { 
        type: 'line', 
        data: { 
            labels: dailyLabels.map(day => formatDate(day)),
            datasets: [{ 
                label: 'จำนวนผู้ใช้', 
                data: dailyData, 
                borderColor: '#26A69A',
                backgroundColor: 'rgba(38, 166, 154, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#26A69A',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4
            }] 
        },
        options: getChartOptions('จำนวนผู้ใช้ต่อวัน')
    });

    // แผนภูมิระดับชั้น
    const levels = ['ม.1', 'ม.2', 'ม.3', 'ม.4', 'ม.5', 'ม.6', 'ครู/บุคลากร'];
    const levelData = levels.map(level => levelCounts[level] || 0);
    const levelColors = ['#26A69A', '#AED581', '#FFCA28', '#FF8A65', '#EF5350', '#4A2C6D', '#0288D1'];
    
    const ctx2 = document.getElementById('chartClass').getContext('2d');
    if(charts.class) charts.class.destroy();
    
    charts.class = new Chart(ctx2, { 
        type: 'bar', 
        data: { 
            labels: levels,
            datasets: [{ 
                label: 'จำนวน', 
                data: levelData, 
                backgroundColor: levelColors,
                borderColor: levelColors,
                borderWidth: 1
            }] 
        },
        options: getChartOptions('จำนวนผู้ใช้ตามระดับชั้น')
    });

    // แผนภูมิวัตถุประสงค์
    const purposes = Object.keys(purposeCounts);
    const purposeData = purposes.map(purpose => purposeCounts[purpose]);
    const purposeColors = ['#26A69A', '#AED581', '#FFCA28', '#FF8A65', '#EF5350', '#4A2C6D'];
    
    const ctx3 = document.getElementById('chartPurpose').getContext('2d');
    if(charts.purpose) charts.purpose.destroy();
    
    charts.purpose = new Chart(ctx3, {
        type: 'doughnut',
        data: {
            labels: purposes,
            datasets: [{
                data: purposeData,
                backgroundColor: purposeColors.slice(0, purposes.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: 'Sarabun',
                            size: 11
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    // แผนภูมิ Top Users
    const topUsers = Object.entries(userCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    const topUserNames = topUsers.map(user => user[0]);
    const topUserCounts = topUsers.map(user => user[1]);
    
    const ctx4 = document.getElementById('chartTopUsers').getContext('2d');
if(charts.topUsers) charts.topUsers.destroy();

// สีสำหรับแต่ละผู้ใช้ (10 สีที่แตกต่างกัน)
const userColors = [
    '#26A69A', '#AED581', '#FFCA28', '#FF8A65', '#EF5350',
    '#4A2C6D', '#D32F2F', '#F57C00', '#FBC02D', '#0288D1',
    '#7B1FA2', '#C2185B', '#00796B', '#388E3C', '#F57C00'
];

charts.topUsers = new Chart(ctx4, {
    type: 'bar',
    data: {
        labels: topUserNames,
        datasets: [{
            label: 'จำนวนครั้งที่ใช้บริการ',
            data: topUserCounts,
            backgroundColor: topUserNames.map((_, index) => userColors[index % userColors.length]),
            borderColor: topUserNames.map((_, index) => userColors[index % userColors.length]),
            borderWidth: 2,
            borderRadius: 4,
            borderSkipped: false,
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `จำนวนครั้ง: ${context.parsed.x} ครั้ง`;
                    }
                }
            },
            title: {
                display: true,
                text: 'Top 10 ผู้ใช้งานสูงสุด',
                font: {
                    family: 'Sarabun',
                    size: 14,
                    weight: 'bold'
                },
                padding: 20
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'จำนวนครั้งที่ใช้บริการ',
                    font: {
                        family: 'Sarabun',
                        size: 12
                    }
                },
                ticks: {
                    font: {
                        family: 'Sarabun'
                    },
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                }
            },
            y: {
                ticks: {
                    font: {
                        family: 'Sarabun',
                        size: 11,
                        weight: '500'
                    },
                    color: '#374151'
                },
                grid: {
                    display: false
                }
            }
        },
        animation: {
            duration: 1000,
            easing: 'easeOutQuart'
        },
        maintainAspectRatio: false
    }
});
}

// ฟังก์ชันแสดงกิจกรรมล่าสุด
// ฟังก์ชันแสดงกิจกรรมล่าสุด
function renderRecentActivity(data) {
    const tbody = document.getElementById('recentActivityBody');
    const noDataDiv = document.getElementById('noRecentActivity');
    
    // เรียงข้อมูลล่าสุดขึ้นก่อน
    const recentData = data
        .sort((a, b) => new Date(b.date + ' ' + (b.timeIn || '00:00')) - new Date(a.date + ' ' + (a.timeIn || '00:00')))
        .slice(0, 5);
    
    if (recentData.length === 0) {
        tbody.innerHTML = '';
        noDataDiv.classList.remove('hidden');
        return;
    }
    
    noDataDiv.classList.add('hidden');
    tbody.innerHTML = '';
    
    recentData.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50 transition-colors';
        tr.innerHTML = `
            <td class="px-4 py-3 font-medium">${formatThaiDate(item.date)}</td>
            <td class="px-4 py-3">
                <div class="font-medium text-gray-800">${item.name}</div>
                ${item.studentId ? `<div class="text-xs text-gray-500">${item.studentId}</div>` : ''}
            </td>
            <td class="px-4 py-3">
                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-medium">${item.level}</span>
            </td>
            <td class="px-4 py-3 text-sm">${item.purpose}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${item.timeIn || '-'}</td>
        `;
        tbody.appendChild(tr);
    });
}
// ฟังก์ชันสร้างรายงาน
function generateReport() {
    Swal.fire({
        title: 'กำลังสร้างรายงาน',
        text: 'ระบบกำลังสร้างรายงานสรุปสถิติ...',
        icon: 'info',
        showConfirmButton: false,
        timer: 2000
    });
}

// ฟังก์ชันช่วยเหลือเพิ่มเติม
function getLast30Days() {
    const days = [];
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}
function getChartOptions(title) {
    return {
        responsive: true,
        plugins: {
            legend: {
                labels: {
                    font: {
                        family: 'Sarabun'
                    }
                }
            },
            title: {
                display: true,
                text: title,
                font: {
                    family: 'Sarabun',
                    size: 14
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    font: {
                        family: 'Sarabun'
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        family: 'Sarabun'
                    }
                }
            }
        }
    };
}


// ฟังก์ชันช่วยเหลือเพิ่มเติม
function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}


function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('th-TH', {
        day: '2-digit',
        month: '2-digit'
    });
}

        // --- NAVIGATION & AUTH ---
        function switchPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-'+pageId)) document.getElementById('nav-'+pageId).classList.add('active');
            if(window.innerWidth < 768) document.getElementById('sidebarNav').classList.add('hidden');
        }

        function handleAdminClick(page) {
if(isAdminLoggedIn) { 
        switchPage(page); 
        if(page === 'admin') {
            renderAdminDashboard();
        }
        return; 
    }
            Swal.fire({
                title: 'Admin Access', input: 'password', showCancelButton: true,
                confirmButtonText: 'Login', confirmButtonColor: '#AEC6CF'
            }).then((res) => {
                if(res.isConfirmed && res.value === '1234') {
                    isAdminLoggedIn = true;
                    switchPage(page);
                    if(page === 'admin') renderAdminDashboard();
                    Swal.fire({toast:true, position:'top-end', icon:'success', title:'Welcome Admin', showConfirmButton:false, timer:1500});
                } else if (res.isConfirmed) {
                    Swal.fire('Wrong Password', '', 'error');
                }
            });
        }

        function handleLogout() {
            isAdminLoggedIn = false;
            switchPage('dashboard');
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'Logged Out', showConfirmButton:false, timer:1500});
        }

        function refreshData() { fetchData(); }
        function exportToExcel() { XLSX.writeFile(XLSX.utils.json_to_sheet(allData), "Data.xlsx"); }
        function updateStatus(text, color) {
            const el = document.getElementById('connectionStatus');
            el.textContent = text;
            el.parentElement.className = `px-4 py-2 rounded-lg border text-xs transition-colors duration-300 ${color === 'green' ? 'gradient-card-4 border-green-100 text-green-800' : color === 'red' ? 'bg-red-50 border-red-100 text-red-800' : 'bg-yellow-50 border-yellow-100 text-yellow-800'}`;
        }

        // --- MOCK API (Fallback) ---
        async function mockAPI(payload) {
            await new Promise(r => setTimeout(r, 500));
            if(payload.action === 'read') return { status: 'success', data: JSON.parse(localStorage.getItem('lib_data')||'[]') };
            if(payload.action === 'create') { 
                let d = JSON.parse(localStorage.getItem('lib_data')||'[]'); 
                d.push({id:Date.now(), ...payload}); localStorage.setItem('lib_data',JSON.stringify(d));
                return { status: 'success' };
            }
            if(payload.action === 'borrow_read') return { status: 'success', data: JSON.parse(localStorage.getItem('lib_borrow')||'[]') };
            if(payload.action === 'borrow_create') {
                let d = JSON.parse(localStorage.getItem('lib_borrow')||'[]');
                d.unshift({id:'b_'+Date.now(), status:'pending', ...payload}); localStorage.setItem('lib_borrow',JSON.stringify(d));
                return { status: 'success' };
            }
            if(payload.action === 'borrow_update') {
                let d = JSON.parse(localStorage.getItem('lib_borrow')||'[]');
                let item = d.find(x => x.id == payload.id); if(item) item.status = payload.status;
                localStorage.setItem('lib_borrow', JSON.stringify(d));
                return { status: 'success' };
            }
            return { status: 'success' };
        }
        
        // --- HELPER FOR MOCK ---
        function generateMockData() {
             // ... existing generator logic or simple check
             if(!localStorage.getItem('lib_data')) {
                 // Pre-fill some data if empty
                 const d = []; /* fill with sample */
                 localStorage.setItem('lib_data', JSON.stringify(d));
                 return d;
             }
             return JSON.parse(localStorage.getItem('lib_data'));
        }
        function initBorrowData() {
            if(!localStorage.getItem('lib_borrow')) {
                 const d = [
                    { id: 'b_1', date: '2023-10-27', book: 'แฮร์รี่ พอตเตอร์', borrower: 'สมชาย ใจดี', status: 'pending' },
                    { id: 'b_2', date: '2023-10-26', book: 'วิทยาศาสตร์ ม.1', borrower: 'มานี มีตา', status: 'approved' }
                 ];
                 localStorage.setItem('lib_borrow', JSON.stringify(d));
                 borrowData = d;
            } else {
                 borrowData = JSON.parse(localStorage.getItem('lib_borrow'));
            }
        }

// อัพเดทเมื่อโหลดหน้า
window.onload = function() {
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('th-TH');
    document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
    fetchData();
};
    </script>
</body>
</html>
